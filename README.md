# Story Engine
### Den AI-drevne publiseringsplattformen.

![React](https://img.shields.io/badge/React-00599C?style=for-the-badge&logo=react&logoColor=white)
![TypeScript](https://img.shields.io/badge/TypeScript-007ACC?style=for-the-badge&logo=typescript&logoColor=white)
![Vite](https://img.shields.io/badge/Vite-646CFF?style=for-the-badge&logo=vite&logoColor=white)
![Gemini 3 Pro](https://img.shields.io/badge/Gemini_3_Pro-8E75B2?style=for-the-badge&logo=google&logoColor=white)
![Made in Norway](https://img.shields.io/badge/Made_in_Norway-A63A3A?style=for-the-badge&logo=flag-icon&logoColor=white)

![Story Engine Infographic](public/infographic.png)

> **Story Engine effektiviserer produksjonen av innhold og sikrer fakta ved hjelp av avanserte AI-agenter. Fra Ã©n idÃ© til ferdig dokument, lydbok og video â€“ kvalitetssikret.**

---

## ğŸš€ NÃ¸kkelfunksjoner

*   âœï¸ **Smart Prompt-utvidelse**: Usikker pÃ¥ hvordan du skal formulere deg? Ett klikk forvandler enkle stikkord til en rik, detaljert prosjektbeskrivelse optimalisert for at AI-en skal gi best mulig resultat.

*   âœ¨ **AI-anbefalte innstillinger**: FÃ¥ forslag til kategori, sjanger/format (155 kombinasjoner), sÃ¸k og kreativitet â€“ automatisk tilpasset din idÃ©.

*   ğŸ“„ **Native Dokumentgenerering**: Skaper ekte PDF, DOCX og MP3-filer direkte i nettleseren uten eksterne konverteringstjenester.

*   ğŸŒ **Interaktiv Nettside**: Eksporter prosjektet ditt som en komplett, responsiv nettside (.zip) med mÃ¸rkt tema, innholdsfortegnelse, og integrert lyd/bilde-avspilling.

*   ğŸ¬ **Smart Video-produksjon**: Genererer videoer (.webm) per kapittel med synkronisert lyd og tekst. Bruker "Smart Split"-teknologi for Ã¥ sikre perfekt typografi (overskrifter vs. brÃ¸dtekst).

*   ğŸ“Š **PowerPoint-eksport (Non-Fiction)**: AI-genererte presentasjoner med oppsummerte bullet points, kapittelillustrasjoner og Mermaid-diagrammer pÃ¥ dedikerte slides.

*   ğŸ“š **EPUB E-bok**: Eksporter som universell e-bok med cover, kapittelnavigasjon og bilder â€“ klar for Apple Books, Kobo, Kindle og andre e-lesere.

*   ğŸ“‚ **Analyser hva som helst**: Start prosjektet ditt med en lydfil, video, bilde, dokument, kodefil eller et helt .zip-arkiv. AI-en forstÃ¥r innholdet og skriver "Core Idea" for deg.

*   ğŸ› ï¸ **AI-verktÃ¸ykasse for spesialoppgaver**: UtfÃ¸r avanserte oppgaver med ett klikk â€“ konverter lydfiler til undertekster (.srt), generer en komplett README.md fra et .zip-arkiv, eller trekk ut et profesjonelt sammendrag fra et langt dokument.

*   ğŸŒ **Full sprÃ¥k-kontroll**: Velg mellom auto-deteksjon eller spesifiser nÃ¸yaktig hvilket sprÃ¥k historien skal skrives pÃ¥. Inkluderer nÃ¥ oversettelse av eksisterende prosjekter.

*   ğŸ“ **Regenerer fra fil**: Last opp en tidligere generert Story Engine-fil (.txt) for Ã¥ lage nye formater som lyd, video eller nettside med den originale teksten eller oversett til et annet sprÃ¥k.

*   âš™ï¸ **Automatisk struktur**: La AI-en bestemme det optimale antallet seksjoner for historien din basert pÃ¥ kompleksitet og tema, eller velg antall seksjoner selv.

*   ğŸ™ï¸ **Velg din stemmekvalitet**: Bytt mellom to kraftige Text-to-Speech modeller for lydbÃ¸ker â€“ Gemini 2.5 Flash (rask og effektiv) eller Pro (maksimal kvalitet).

*   ğŸ¤– **Multi-Agent System**: Orkestrerer planlegging, skriving og faktasjekk gjennom spesialiserte AI-agenter som samarbeider.

*   ğŸ§¼ **Vaskemaskinen (Sanitizer)**: Automatisk rensing og validering av kode, Markdown og Mermaid-diagrammer fÃ¸r visning. "Self-healing" Mermaid-diagrammer som fikser syntaksfeil automatisk.

---

## ğŸš€ Se Story Engine i aksjon

### ğŸŒ Live Interaktiv Rapport
Opplev en komplett generert leveranse direkte i nettleseren. Klikk pÃ¥ bildet under for Ã¥ utforske den interaktive nettsiden som Story Engine produserer automatisk:

<p align="center">
  <a href="https://neoweb.no/se-walkthrough/index.html">
    <img src="https://neoweb.no/se-walkthrough/infographic.png" width="900" alt="Interaktiv Rapport Demo"/>
  </a>
  <br/>
  <a href="https://neoweb.no/se-walkthrough/index.html"><strong>Ã…pne Interaktiv Demo â”</strong></a>
</p>

---

### ğŸ—ºï¸ Videogjennomgang
> ğŸ’¡ **Klikk pÃ¥ bildene for Ã¥ se videoene direkte fra vÃ¥r server**

<table>
  <tr>
    <td>
      <strong>Seksjon 1: Velkommen til Story Engine</strong><br/>
      <a href="https://neoweb.no/se-walkthrough/chapter-1.webm">
        <img src="https://neoweb.no/se-walkthrough/poster-1.png" width="420" alt="Seksjon 1"/>
      </a><br/>
      Introduksjon til Story Engine og dets muligheter.
    </td>
    <td>
      <strong>Seksjon 2: Slik fungerer det</strong><br/>
      <a href="https://neoweb.no/se-walkthrough/chapter-2.webm">
        <img src="https://neoweb.no/se-walkthrough/poster-2.png" width="420" alt="Seksjon 2"/>
      </a><br/>
      Steg-for-steg gjennomgang av arbeidsflyten.
    </td>
  </tr>
  <tr>
    <td>
      <strong>Seksjon 3: NÃ¸kkelfunksjoner</strong><br/>
      <a href="https://neoweb.no/se-walkthrough/chapter-3.webm">
        <img src="https://neoweb.no/se-walkthrough/poster-3.png" width="420" alt="Seksjon 3"/>
      </a><br/>
      Deep dive i avanserte funksjoner.
    </td>
    <td>
      <strong>Seksjon 4: Teknologi og Sikkerhet</strong><br/>
      <a href="https://neoweb.no/se-walkthrough/chapter-4.webm">
        <img src="https://neoweb.no/se-walkthrough/poster-4.png" width="420" alt="Seksjon 4"/>
      </a><br/>
      Teknisk arkitektur og sikkerhetsprinsipper.
    </td>
  </tr>
</table>

### ğŸ–¥ï¸ Visuell Omvisning App
MÃ¸tet med brukeren â€“ rent, moderne og inviterende.
![Landingsside](public/app-hero-eng.png)

<details>
<summary><strong>Klikk for Ã¥ se Story Engine app</strong></summary>

### Startside app
Etter landingssiden â€“ moderne og stilrent panel.
![Startside app](public/story-engine.png)

### Alternativt smal skjermbredde
Startsiden tilpasses skjermbredden automatisk.
![Startside app small](public/story-engine-small.png)
</details>

<details>
<summary><strong>Klikk for Ã¥ se genereringen i sanntid</strong></summary>

### Generation Progress
Noen trinn fÃ¸r genereringen, her foregÃ¥r researchingen.
![Generation Progress](public/researching.png)

Hvor magien skjer. Her ser brukeren innholdet bli skapt i sanntid, med levende oppdateringer.
![Generation Progress](public/generation-progress.jpg)
</details>

---

## ğŸ—ï¸ Teknisk Arkitektur

<details>
<summary><strong>Klikk for Ã¥ se Dataflyt (Input â†’ Eksport)</strong></summary>

### Dataflyt (Input â†’ Eksport)

Dette diagrammet viser hvordan data beveger seg fra brukerens input, gjennom vÃ¥re prosesseringssteg, og ut som ferdige formater.

```mermaid
graph TD
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% ğŸ“± STORY ENGINE - KOMPLETT DATAFLYT
    %% Oppdatert: Januar 2026
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    %% â”€â”€â”€ FASE -1: LANDING PAGE â”€â”€â”€
    Entry((("ğŸš€ App Start")))
    Entry --> LandingPage["ğŸ  Landing Page<br/><i>LandingPage.tsx</i>"]
    LandingPage -->|"Kom i gang"| UserStart((("ğŸ‘¤ Bruker")))

    %% â”€â”€â”€ FASE 0: INPUT KILDER â”€â”€â”€
    subgraph InputSources ["ğŸ“¥ INPUT KILDER"]
        direction TB
        IdeaInput["ğŸ“ Core Idea<br/><i>Tekstfelt</i>"]
        FileInput["ğŸ“ Fil Upload<br/><i>Audio/Video/Image/<br/>PDF/DOCX/ZIP/Code</i>"]
        URLInput["ğŸŒ URL Analyse<br/><i>Nettside</i>"]
        PlanFile["ğŸ“„ .txt Plan<br/><i>Tidligere eksport</i>"]
    end

    UserStart -->|"Velger kilde"| InputSources

    %% â”€â”€â”€ FASE 1: ANALYSE & AI-ANBEFALINGER â”€â”€â”€
    subgraph Analysis ["ğŸ” ANALYSE & PARSING"]
        direction TB
        FileAnalyzer["âš™ï¸ Fil Analysering<br/><i>fileExtract.ts</i>"]
        PromptService1["ğŸ“‹ Prompt Service<br/><i>getAnalyze*Prompt()</i>"]
        URLAnalyzer["ğŸ”— URL Scraping<br/><i>api.ts</i>"]
        FileParser["ğŸ“‘ Plan Parser<br/><i>fileParser.ts</i>"]
        AIRecommend["ğŸ¤– AI Anbefalinger<br/><i>getRecommendedSettings()</i>"]
    end

    IdeaInput -->|"Direkte tekst"| AIRecommend
    AIRecommend -->|"ForeslÃ¥r innstillinger"| UI["ğŸ¨ IntroView<br/><i>Konfigurasjon</i>"]
    
    FileInput -->|"analyzeReferenceFile()"| FileAnalyzer
    FileAnalyzer -->|"getAnalyze*Prompt()"| PromptService1
    PromptService1 -->|"Prompt basert pÃ¥ filtype"| GeminiAPI1["ğŸ¤– Gemini API<br/><i>2.5-flash/pro</i>"]
    
    URLInput -->|"analyzeUrl()"| URLAnalyzer
    URLAnalyzer -->|"Henter innhold"| GeminiAPI1
    
    GeminiAPI1 -->|"Returnerer analyse"| CoreIdea["ğŸ’¡ Core Idea<br/><i>Populert</i>"]
    CoreIdea --> AIRecommend
    
    PlanFile -->|"parseNovelPlanFromFile()"| FileParser
    FileParser -->|"Ferdig plan"| PlanReady["ğŸ“‹ NovelPlan<br/><i>Klar til bruk</i>"]

    %% â”€â”€â”€ FASE 2: PLANLEGGING â”€â”€â”€
    subgraph Planning ["ğŸ“ PLANLEGGING"]
        direction TB
        PlanGenerator["ğŸ“ Plan Generator<br/><i>generateNovelPlan()</i>"]
        PromptService2["ğŸ“‹ Prompt Service<br/><i>getNovelPlanPrompt()</i><br/><i>+ Sub-options</i>"]
    end

    UI -->|"handleStartPlanning()"| PlanningLogic{"ğŸ¤” Har vi<br/>en plan?"}
    PlanningLogic -->|"Nei"| PlanGenerator
    PlanningLogic -->|"Ja: Fra fil"| PlanReady

    PlanGenerator -->|"getNovelPlanPrompt()"| PromptService2
    PromptService2 -->|"Strukturert prompt"| GeminiAPI2["ğŸ¤– Gemini API<br/><i>2.5-pro</i>"]

    GeminiAPI2 --> SearchDecision{"ğŸ” Google<br/>Search?"}
    SearchDecision -->|"Ja"| SearchAPI["ğŸŒ Google Search<br/><i>Grounding + Citations</i>"]
    SearchAPI -->|"Grounded data"| GeminiAPI2
    SearchDecision -->|"Nei"| NoSearch["ğŸ“„ Standard<br/>generering"]
    NoSearch --> PlanReady
    GeminiAPI2 -->|"JSON Plan + metadata"| PlanReady

    %% â”€â”€â”€ FASE 3: COVER IMAGE â”€â”€â”€
    subgraph CoverGen ["ğŸ–¼ï¸ COVER GENERERING"]
        direction LR
        ImageGen["ğŸ¨ Imagen 4.0<br/><i>Ultra/Standard/Fast</i>"]
        ModelPricing["ğŸ’° modelPricing<br/><i>Kostnadssporing</i>"]
    end
    
    PlanReady -->|"generateImage()"| ImageGen
    ImageGen -->|"incrementImageCount()"| ModelPricing
    ImageGen -->|"Base64 bilde"| PlanWithCover["ğŸ“– NovelPlan<br/><i>+ coverImageUrl</i>"]

    %% â”€â”€â”€ FASE 4: INNHOLDSGENERERING â”€â”€â”€
    subgraph ContentGen ["âœï¸ INNHOLDSGENERERING"]
        direction TB
        ChapterGen["ğŸ“š Kapittel Generator<br/><i>generateChapterBatch()</i>"]
        PromptService3["ğŸ“‹ Prompt Service<br/><i>getBaseChapterPrompt()</i><br/><i>+ markdownRules</i>"]
        StreamHandler["ğŸ“¡ Stream Handler<br/><i>chapters.ts</i>"]
    end

    PlanWithCover -->|"Batch av kapitler"| ChapterGen
    ChapterGen -->|"getBaseChapterPrompt()"| PromptService3
    PromptService3 -->|"Strukturert prompt"| GeminiAPI3["ğŸ¤– Gemini API<br/><i>2.5-pro Streaming</i>"]
    GeminiAPI3 -->|"Streamer Markdown"| StreamHandler

    %% â”€â”€â”€ FASE 5: VASKEMASKINEN â”€â”€â”€
    subgraph Sanitizer ["ğŸ§¼ VASKEMASKINEN"]
        direction LR
        RawMD["ğŸ“„ RÃ¥ MD"]
        Fix1["ğŸ”§ ContentSanitizer<br/><i>Tags/Headers</i>"]
        Fix2["âœ… mermaidFixer<br/><i>Diagram-validering</i>"]
        Fix3["ğŸ“ Spacing<br/><i>Tabeller/Lister</i>"]
        CleanMD["âœ¨ Ren MD"]
        RawMD --> Fix1 --> Fix2 --> Fix3 --> CleanMD
    end

    StreamHandler --> RawMD

    %% â”€â”€â”€ FASE 6: ADD-ONS â”€â”€â”€
    subgraph AddOns ["ğŸ ADD-ONS"]
        direction TB
        AddOnProcessor["âš¡ processChapterAddOns()<br/><i>chapters.ts</i>"]
        ChapterImageGen["ğŸ–¼ï¸ Imagen 4.0<br/><i>Illustrasjoner</i>"]
        NarrationGen["ğŸ™ï¸ Gemini TTS<br/><i>tts.ts</i>"]
        SmartChunking["âœ‚ï¸ Smart Chunking<br/><i>Bevarer linjeskift</i>"]
    end

    CleanMD -->|"Kapittel ferdig"| AddOnProcessor

    AddOnProcessor --> IllustrationDecision{"ğŸ–¼ï¸ Bilder?"}
    IllustrationDecision -->|"Ja"| ChapterImageGen
    ChapterImageGen -->|"Base64 bilde"| ChapterWithImage["ğŸ“– Chapter<br/><i>+ imageUrl</i>"]
    IllustrationDecision -->|"Nei"| ChapterWithImage

    ChapterWithImage --> AudioDecision{"ğŸ”Š Audio?"}
    AudioDecision -->|"Narrasjon"| SmartChunking
    SmartChunking -->|"Tekstbiter med \\n"| NarrationGen
    AudioDecision -->|"Nei"| FinalChapter["ğŸ“– GeneratedChapter<br/><i>Ferdig</i>"]
    NarrationGen -->|"Base64 audio"| FinalChapter

    %% â”€â”€â”€ FASE 7: STATE & KOSTNADSSPORING â”€â”€â”€
    subgraph StateTracking ["ğŸ’¾ STATE & SPORING"]
        direction LR
        AppState[("App State<br/><i>React</i>")]
        UsageMetrics["ğŸ“Š UsageMetrics<br/><i>Tokens/Images/Audio</i>"]
    end
    
    FinalChapter -->|"setGeneratedNovel()"| AppState
    ModelPricing --> UsageMetrics
    AppState --> UsageMetrics

    %% â”€â”€â”€ FASE 8: RENDERING â”€â”€â”€
    AppState -->|"Sender data"| Viewer["ğŸ–¥ï¸ ContentRenderer<br/><i>react-markdown + Mermaid</i>"]
    Viewer -->|"Rendrer innhold"| Screen["ğŸ“º GenerationView<br/><i>Live + Yellow text</i>"]

    %% â”€â”€â”€ FASE 9: EKSPORT â”€â”€â”€
    UserEnd((("ğŸ‘¤ Bruker")))
    UserEnd -.->|"Ser dokument"| Screen
    UserEnd -->|"Last Ned"| DownloadBtn["â¬‡ï¸ DownloadModal<br/><i>Format + Progress</i>"]

    DownloadBtn --> FormatChoice{"ğŸ“ Format?"}

    subgraph ExportService ["ğŸ“¤ EKSPORT SERVICE"]
        direction TB
        DLService["ğŸ”§ downloadService"]
        ContentParse["ğŸ“‘ ContentParser<br/><i>MD â†’ Blokker</i>"]
        ExportModules["ğŸ“¦ Export Modules<br/><i>docx/pdf/video/website</i>"]
        FullMD["ğŸ“„ Full Markdown<br/><i>YAML + Innhold</i>"]
        DLService --> ContentParse
        DLService --> ExportModules
        DLService --> FullMD
    end

    AppState -->|"NovelPlan + Chapters"| DLService
    UsageMetrics -->|"Produksjonsrapport"| DLService

    subgraph ExportFormats ["ğŸ’¾ EKSPORT FORMATER"]
        direction TB
        ExportTXT["ğŸ“„ .txt<br/><i>YAML + Markdown</i>"]
        GeneratePDF["ğŸ“• PDF Generator<br/><i>jsPDF + Bold/Italic</i>"]
        ExportPDF["ğŸ“• .pdf<br/><i>A4 + Mermaid PNG</i>"]
        GenerateDOCX["ğŸ“˜ DOCX Generator<br/><i>docx + Numbered lists</i>"]
        ExportDOCX["ğŸ“˜ .docx<br/><i>Native Word</i>"]
        GenerateMP3["ğŸµ Audio Processor<br/><i>WAV Header</i>"]
        ExportMP3["ğŸµ .zip<br/><i>MP3 64kbps per kapittel</i>"]
        GenerateWebM["ğŸ¬ Video Processor<br/><i>Canvas + Smart Split</i>"]
        ExportWebM["ğŸ¬ .zip<br/><i>WebM per kapittel</i>"]
        GenerateWebsite["ğŸŒ Web Generator<br/><i>HTML/CSS/JS Bundle</i>"]
        ExportWebsite["ğŸŒ .zip<br/><i>Interaktiv side</i>"]
        GeneratePPTX["ğŸ“Š PPTX Generator<br/><i>AI Summarize + PptxGenJS</i>"]
        ExportPPTX["ğŸ“Š .pptx<br/><i>Non-Fiction presentasjon</i>"]
        GenerateEPUB["ğŸ“š EPUB Generator<br/><i>XHTML + Cover</i>"]
        ExportEPUB["ğŸ“š .epub<br/><i>Universell e-bok</i>"]
    end

    FormatChoice -->|"TXT"| ExportTXT
    FullMD --> ExportTXT

    FormatChoice -->|"PDF"| GeneratePDF
    ContentParse --> GeneratePDF
    GeneratePDF --> ExportPDF

    FormatChoice -->|"DOCX"| GenerateDOCX
    ContentParse --> GenerateDOCX
    GenerateDOCX --> ExportDOCX

    FormatChoice -->|"MP3"| GenerateMP3
    AppState -->|"audioContent"| GenerateMP3
    GenerateMP3 --> ExportMP3

    FormatChoice -->|"WebM"| GenerateWebM
    AppState -->|"audio + image"| GenerateWebM
    GenerateWebM --> ExportWebM

    FormatChoice -->|"Nettside"| GenerateWebsite
    AppState -->|"Plan + Chapters"| GenerateWebsite
    GenerateWebsite --> ExportWebsite

    FormatChoice -->|"PPTX"| GeneratePPTX
    AppState -->|"Plan + AI Summary"| GeneratePPTX
    GeneratePPTX --> ExportPPTX

    FormatChoice -->|"EPUB"| GenerateEPUB
    ContentParse --> GenerateEPUB
    GenerateEPUB --> ExportEPUB

    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% ğŸ¨ STYLING CLASSES (GitHub Compatible)
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    classDef userNode fill:#fef3c7,stroke:#d97706,stroke-width:3px,color:#92400e
    classDef landingNode fill:#fce7f3,stroke:#be185d,stroke-width:2px,color:#9d174d
    classDef apiNode fill:#dbeafe,stroke:#2563eb,stroke-width:2px,color:#1e40af
    classDef processNode fill:#f3e8ff,stroke:#7c3aed,stroke-width:2px,color:#5b21b6
    classDef serviceNode fill:#e0e7ff,stroke:#4f46e5,stroke-width:2px,color:#3730a3
    classDef stateNode fill:#dcfce7,stroke:#16a34a,stroke-width:3px,color:#166534
    classDef exportNode fill:#fce7f3,stroke:#db2777,stroke-width:2px,color:#9d174d
    classDef decisionNode fill:#fff7ed,stroke:#ea580c,stroke-width:2px,color:#c2410c
    classDef sanitizerNode fill:#e0f2fe,stroke:#0284c7,stroke-width:2px,color:#075985
    classDef viewNode fill:#f5f3ff,stroke:#7c3aed,stroke-width:2px,color:#5b21b6
    classDef metricsNode fill:#fef9c3,stroke:#ca8a04,stroke-width:2px,color:#854d0e

    class Entry,UserStart,UserEnd userNode
    class LandingPage landingNode
    class GeminiAPI1,GeminiAPI2,GeminiAPI3,SearchAPI,ImageGen,ChapterImageGen,NarrationGen apiNode
    class UI,ChapterGen,StreamHandler,Viewer,AddOnProcessor,AIRecommend,SmartChunking processNode
    class PromptService1,PromptService2,PromptService3,DLService,FileAnalyzer,URLAnalyzer,FileParser,ContentParse,DocStyles,ExportModules serviceNode
    class AppState,PlanReady,CoreIdea,FinalChapter,PlanWithCover,ChapterWithImage,PlanGenerator,NoSearch stateNode
    class ExportTXT,ExportPDF,ExportDOCX,ExportMP3,ExportWebM,ExportWebsite,GeneratePDF,GenerateDOCX,GenerateMP3,GenerateWebM,GenerateWebsite,FullMD,DownloadBtn exportNode
    class PlanningLogic,SearchDecision,IllustrationDecision,AudioDecision,FormatChoice decisionNode
    class RawMD,Fix1,Fix2,Fix3,CleanMD sanitizerNode
    class Screen viewNode
    class ModelPricing,UsageMetrics metricsNode
```
![Oversikt](public/flowchart-tr.png)
</details>

<details>
<summary><strong>Klikk for Ã¥ se Sekvensdiagram (Interaksjon)</strong></summary>

### Sekvensdiagram (Interaksjon)

Hvordan frontend kommuniserer med AI-modellene og hÃ¥ndterer asynkrone strÃ¸mmer.

```mermaid
%%{init: {
  'theme': 'base',
  'themeVariables': {
    'primaryColor': '#6366f1',
    'primaryTextColor': '#ffffff',
    'primaryBorderColor': '#4f46e5',
    'secondaryColor': '#10b981',
    'tertiaryColor': '#f0f9ff',
    'lineColor': '#6366f1',
    'noteTextColor': '#1e293b',
    'noteBkgColor': '#fef3c7',
    'noteBorderColor': '#f59e0b',
    'actorTextColor': '#1e293b',
    'actorBkg': '#e0e7ff',
    'actorBorder': '#6366f1',
    'activationBkgColor': '#c7d2fe',
    'activationBorderColor': '#4f46e5',
    'sequenceNumberColor': '#ffffff'
  },
  'sequence': {
    'mirrorActors': false,
    'messageAlign': 'center',
    'width': 180,
    'useMaxWidth': true
  }
}}%%

sequenceDiagram
    autonumber
    
    box rgba(99, 102, 241, 0.1) ğŸ¯ BRUKERGRENSESNITT
        participant User as ğŸ‘¤ Bruker
        participant FE as ğŸ–¥ï¸ Frontend
    end
    
    box rgba(16, 185, 129, 0.1) ğŸ§  AI-MOTOR
        participant AI as âš¡ Gemini API
        participant Search as ğŸ” Google Search
        participant Imagen as ğŸ¨ Imagen
    end
    
    box rgba(245, 158, 11, 0.1) âš™ï¸ PROSESSERING
        participant San as ğŸ›¡ï¸ Sanitizer
        participant Parse as ğŸ“‘ Parser
        participant DL as ğŸ“¦ Download
    end

    Note over User,DL: ğŸ¯ FASE 1: Input & AI-Anbefalinger
    
    User->>+FE: ğŸ“ Input: IdÃ©, fil eller URL
    FE->>+AI: ğŸ¤– Analyser innhold
    AI-->>-FE: ğŸ’¡ Core Idea + Anbefalinger
    FE-->>User: âœ¨ ForeslÃ¥tt kategori/sjanger/sÃ¸k

    Note over User,DL: ğŸ“ FASE 2: Planlegging & Research
    
    User->>FE: âœ… Godkjenn innstillinger
    FE->>+AI: ğŸ“‹ Generer plan
    
    alt ğŸ” Google Search aktivert
        AI->>+Search: SÃ¸k etter fakta
        Search-->>-AI: ğŸ“° Grounded data + kilder
    end
    
    AI-->>-FE: ğŸ“– NovelPlan (JSON)
    FE->>+Imagen: ğŸ–¼ï¸ Generer cover
    Imagen-->>-FE: ğŸ¨ Base64 bilde

    Note over User,DL: âœï¸ FASE 3: Innholdsgenerering
    
    FE->>+AI: ğŸ“š Generer kapitler (batch)
    
    loop ğŸ“– Per kapittel (streaming)
        AI-->>FE: âœ¨ Markdown chunk
        FE->>San: ğŸ§¼ Valider + rens
        San-->>FE: âœ… Ren output
        FE-->>User: ğŸ–¼ï¸ Live oppdatering (gul tekst)
    end
    
    AI-->>-FE: âœ… Alle kapitler ferdig
    
    opt ğŸ Add-ons aktivert
        loop ğŸ“– Per kapittel
            opt ğŸ–¼ï¸ Illustrasjoner
                FE->>+Imagen: Generer kapittel-bilde
                Imagen-->>-FE: ğŸ¨ Base64 bilde
            end
            opt ğŸ™ï¸ Audio
                FE->>+AI: TTS narrasjon
                AI-->>-FE: ğŸ”Š Base64 audio
            end
        end
    end
    
    FE-->>User: ğŸ“º Komplett visning (hvit tekst)

    Note over User,DL: ğŸ“¥ FASE 4: Eksport & Levering
    
    User->>FE: ğŸ“ Velg eksportformat
    FE->>Parse: ğŸ“‘ MD â†’ Strukturerte blokker
    Parse-->>FE: ğŸ“¦ Headers, lister, tabeller, mermaid
    
    alt ğŸ“„ Dokument (TXT)
        FE->>+DL: YAML + Markdown
        DL-->>-User: â¬‡ï¸ .txt fil
    else ğŸ“• Dokument (PDF)
        FE->>+DL: Blokker â†’ jsPDF
        DL->>DL: ğŸ¨ Bold/italic + Mermaid PNG
        DL-->>-User: â¬‡ï¸ .pdf fil
    else ğŸ“˜ Dokument (DOCX)
        FE->>+DL: Blokker â†’ docx
        DL->>DL: ğŸ“ Numbered lists + styling
        DL-->>-User: â¬‡ï¸ .docx fil
    else ğŸµ Audio (MP3)
        FE->>+DL: Audio chunks â†’ lamejs (64kbps)
        DL-->>-User: â¬‡ï¸ .zip (MP3 per kapittel)
    else ğŸ¬ Video (WebM)
        FE->>+DL: Audio + bilder â†’ WebCodecs
        DL-->>-User: â¬‡ï¸ .zip (WebM per kapittel)
    else ğŸŒ Nettside (ZIP)
        FE->>+DL: Samle HTML/CSS/JS + Assets
        DL->>DL: ğŸ“š Render Mermaid PNGs
        DL-->>-User: â¬‡ï¸ .zip (Interaktiv side)
    else ğŸ“Š PowerPoint (PPTX)
        FE->>+DL: AI oppsummer â†’ PptxGenJS
        DL->>DL: ğŸ¯ Slides + diagrammer
        DL-->>-User: â¬‡ï¸ .pptx fil
    else ğŸ“š E-bok (EPUB)
        FE->>+DL: Blokker â†’ XHTML + Cover
        DL->>DL: ğŸ“¦ EPUB 3 pakking
        DL-->>-User: â¬‡ï¸ .epub fil
    end
    
    Note over User,DL: ğŸ“Š Kostnadssporing oppdateres kontinuerlig
```
</details>

---

## ğŸ“‚ Filstruktur & Modul-analyse

<details>
<summary><strong>Klikk for filstruktur</strong></summary>

Prosjektet har gjennomgÃ¥tt en omfattende refaktorering for Ã¥ Ã¸ke vedlikeholdbarhet og skalerbarhet. Vi bruker nÃ¥ en tydelig domenestruktur under services.

```text
.
â”œâ”€â”€ App.tsx                      # Global state, view-ruting og kostnadssporing
â”œâ”€â”€ README.md                    # Dokumentasjon
â”œâ”€â”€ CHANGELOG.md                 # Endringslogg
â”œâ”€â”€ ROADMAP.md                   # Veikart og fremtidsplaner
â”œâ”€â”€ constants.ts                 # Globale konstanter (stemmer, stiler)
â”œâ”€â”€ types.ts                     # TypeScript definisjoner for hele applikasjonen
â”œâ”€â”€ genres.ts                    # Definisjoner av hovedsjangre og kategorier
â”œâ”€â”€ genreOptions.ts              # Kontekstuelle sub-options (faktasjekk, lengde, etc.)
â”œâ”€â”€ languages.ts                 # StÃ¸ttede sprÃ¥k for I/O
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ Icons.tsx                # Ikoner (SVG)
â”‚   â”œâ”€â”€ ParserTest.tsx           # Test-komponent for parser
â”‚   â”œâ”€â”€ landing/                 # Landingsside komponenter
â”‚   â”‚   â””â”€â”€ LandingPage.tsx      # Hovedinngang / Hero-seksjon
â”‚   â”œâ”€â”€ ui/                      # Gjenbrukbare UI-komponenter
â”‚   â”‚   â”œâ”€â”€ ContentRenderer.tsx  # Markdown/Mermaid renderer (ReactMarkdown)
â”‚   â”‚   â”œâ”€â”€ DownloadModal.tsx    # Modal for valg av eksportformat
â”‚   â”‚   â”œâ”€â”€ ErrorBoundary.tsx    # FeilhÃ¥ndtering
â”‚   â”‚   â”œâ”€â”€ LoadingView.tsx      # Animerte laste-steg (Analyzing -> Finalizing)
â”‚   â”‚   â”œâ”€â”€ LogViewer.tsx        # Debug-konsoll i UI
â”‚   â”‚   â”œâ”€â”€ Mermaid.tsx          # Wrapper for Mermaid-diagrammer
â”‚   â”‚   â”œâ”€â”€ PlanningStepper.tsx  # Visuell fremdriftsindikator
â”‚   â”‚   â”œâ”€â”€ ResearchSourcesBox.tsx # Visning av Google Search-kilder
â”‚   â”‚   â””â”€â”€ SettingsModal.tsx    # Avanserte innstillinger (Logger, Terskelverdier)
â”‚   â””â”€â”€ views/                   # Hovedvisninger (States)
â”‚       â”œâ”€â”€ LoginView.tsx        # Innlogging og autentisering
â”‚       â”œâ”€â”€ WaitlistView.tsx     # Venteliste og early access
â”‚       â”œâ”€â”€ IntroView.tsx        # Input, filanalyse, drag-n-drop
â”‚       â”œâ”€â”€ CastingView.tsx      # Karakteroversikt og stemmevalg
â”‚       â”œâ”€â”€ GenerationView.tsx   # Live streaming av innhold
â”‚       â””â”€â”€ CompleteView.tsx     # Ferdig resultat, avspilling og regenerering
â”œâ”€â”€ services/                    # FORRETNINGSLOGIKK (MODULÃ†R)
â”‚   â”œâ”€â”€ ContentParser.ts         # AST-parser som konverterer MD til blokker
â”‚   â”œâ”€â”€ ContentSanitizer.ts      # "Vaskemaskinen" (Regex-rensing, header-fiks)
â”‚   â”œâ”€â”€ documentStyles.ts        # Fasade for styles/index.ts
â”‚   â”œâ”€â”€ downloadService.ts       # Fasade for export/index.ts
â”‚   â”œâ”€â”€ api.ts                   # URL-analyse og ekstern API-kommunikasjon
â”‚   â”œâ”€â”€ auth.ts                  # Autentiseringslogikk
â”‚   â”œâ”€â”€ formatConstants.ts       # Konstanter for overskriftsformater
â”‚   â”œâ”€â”€ geminiService.ts         # Fasade for ai/index.ts
â”‚   â”œâ”€â”€ modelPricing.ts          # Prismodeller for Gemini/Imagen
â”‚   â”œâ”€â”€ prompts.ts               # Fasade for prompts/index.ts
â”‚   â”œâ”€â”€ supabaseApi.ts           # Klient for Supabase Edge Functions
â”‚   â”œâ”€â”€ supabaseClient.ts        # Supabase autentisering og oppsett
â”‚   â”œâ”€â”€ ai/                      # AI-integrasjon (Google GenAI)
â”‚   â”‚   â”œâ”€â”€ audioHelpers.ts      # PCM/Base64 hjelpere
â”‚   â”‚   â”œâ”€â”€ chapters.ts          # Generering av kapitler (tekst + add-ons)
â”‚   â”‚   â”œâ”€â”€ client.ts            # GoogleGenAI klient-init
â”‚   â”‚   â”œâ”€â”€ config.ts            # Konfigurasjon (tokens, sikkerhet)
â”‚   â”‚   â”œâ”€â”€ fileExtract.ts       # Filanalyse (DOCX, PDF, Code, Images)
â”‚   â”‚   â”œâ”€â”€ imagen.ts            # Bildegenerering (Imagen & Gemini)
â”‚   â”‚   â”œâ”€â”€ index.ts             # EksportÃ¸r
â”‚   â”‚   â”œâ”€â”€ json.ts              # Robust JSON-parsing
â”‚   â”‚   â”œâ”€â”€ plan.ts              # Planlegging og oversettelse
â”‚   â”‚   â”œâ”€â”€ retry.ts             # FeilhÃ¥ndtering og retry-logikk
â”‚   â”‚   â”œâ”€â”€ schemas.ts           # Zod/JSON schemas for AI output
â”‚   â”‚   â”œâ”€â”€ summarize.ts         # AI-oppsummering for PPTX bullet points
â”‚   â”‚   â””â”€â”€ tts.ts               # Tekst-til-tale logikk (Gemini)
â”‚   â”œâ”€â”€ aiHybrid.ts              # Hybrid-lÃ¸sning (Edge Functions + Client)
â”‚   â”œâ”€â”€ export/                  # Eksport-moduler
â”‚   â”‚   â”œâ”€â”€ docx.ts              # DOCX-generering
â”‚   â”‚   â”œâ”€â”€ epub.ts              # EPUB 3 e-bok generering (XHTML + Cover)
â”‚   â”‚   â”œâ”€â”€ index.ts             # EksportÃ¸r
â”‚   â”‚   â”œâ”€â”€ markdown.ts          # Markdown-generering
â”‚   â”‚   â”œâ”€â”€ mp3.ts               # Lyd-sammenstilling (64kbps MP3)
â”‚   â”‚   â”œâ”€â”€ pdf.ts               # PDF-generering med avansert formatering
â”‚   â”‚   â”œâ”€â”€ pptx.ts              # PowerPoint-generering (Non-Fiction)
â”‚   â”‚   â”œâ”€â”€ utils.ts             # Delte eksport-hjelpere (Mermaid render)
â”‚   â”‚   â”œâ”€â”€ video.ts             # Videorendring (WebM) med "Smart Split"
â”‚   â”‚   â””â”€â”€ website.ts           # Interaktiv nettside-pakking (ZIP)
â”‚   â”œâ”€â”€ format/                  # Tekstformatering
â”‚   â”‚   â””â”€â”€ sectionHeaders.ts    # HÃ¥ndtering av kapitteloverskrifter og sprÃ¥k
â”‚   â”œâ”€â”€ i18n/                    # Internasjonalisering
â”‚   â”‚   â””â”€â”€ translations.ts      # Oversettelser (NO/EN) for UI og eksport
â”‚   â”œâ”€â”€ prompts/                 # AI-instrukser (Prompts)
â”‚   â”‚   â””â”€â”€ fragments/           # Gjenbrukbare prompt-deler (Regler)
â”‚   â”‚       â”œâ”€â”€ markdownRules.ts # Regler for MD-struktur
â”‚   â”‚       â”œâ”€â”€ mermaidRules.ts  # Regler for Mermaid v11 syntaks
â”‚   â”‚       â”œâ”€â”€ mermaidSyntaxV11.ts # Detaljerte Mermaid syntaksregler
â”‚   â”‚       â””â”€â”€ professionalVisualization.ts # Konsulent-stil guider
â”‚   â”œâ”€â”€ sanitize/                # Rens og validering
â”‚   â”‚   â””â”€â”€ mermaidFixer.ts      # Self-healing Mermaid logikk
â”‚   â””â”€â”€ styles/                  # Stildefinisjoner
â”‚       â”œâ”€â”€ config.ts            # Globale stilvariabler
â”‚       â”œâ”€â”€ docx.ts              # DOCX-spesifikke stiler
â”‚       â”œâ”€â”€ helpers.ts           # Hjelpefunksjoner for farger/stÃ¸rrelser
â”‚       â”œâ”€â”€ index.ts             # EksportÃ¸r
â”‚       â”œâ”€â”€ pdf.ts               # PDF-spesifikke stiler
â”‚       â”œâ”€â”€ types.ts             # Type-definisjoner for stiler
â”‚       â””â”€â”€ units.ts             # Enhetskonvertering (mm, px, pt)
â”œâ”€â”€ supabase/                    # SUPABASE BACKEND (Edge Functions + DB)
â”‚   â”œâ”€â”€ config.toml              # Supabase lokal konfigurasjon
â”‚   â”œâ”€â”€ deno.json                # Deno konfigurasjon for Edge Functions
â”‚   â”œâ”€â”€ functions/
â”‚   â”‚   â”œâ”€â”€ _shared/             # Delt logikk for alle Edge Functions
â”‚   â”‚   â”‚   â”œâ”€â”€ utils.ts         # Auth, allowlist, kvote-hÃ¥ndtering
â”‚   â”‚   â”‚   â””â”€â”€ rateLimit.ts     # Upstash Redis rate limiting
â”‚   â”‚   â”œâ”€â”€ ai-analyze-file/     # Analyse av opplastede filer (multimodal)
â”‚   â”‚   â”œâ”€â”€ ai-generate-section/ # Server-side generering (SSE Streaming)
â”‚   â”‚   â”œâ”€â”€ ai-image/            # Bildegenerering (Imagen 4.0)
â”‚   â”‚   â”œâ”€â”€ ai-mermaid-fix/      # Mermaid-fiksing med AI
â”‚   â”‚   â”œâ”€â”€ ai-plan/             # Planleggings-agent (Google Search)
â”‚   â”‚   â”œâ”€â”€ ai-script-convert/   # Konvertering til filmmanus
â”‚   â”‚   â”œâ”€â”€ ai-suggest-prompt/   # Prompt-forbedring
â”‚   â”‚   â”œâ”€â”€ ai-suggest-settings/ # Innstillings-anbefalinger
â”‚   â”‚   â”œâ”€â”€ ai-summarize/        # Oppsummerings-agent
â”‚   â”‚   â”œâ”€â”€ ai-tts/              # Tekst-til-tale (Gemini TTS)
â”‚   â”‚   â””â”€â”€ url-analyze/         # Analyse av nettsider (Scraping)
â”‚   â””â”€â”€ migrations/              # Database-migrasjoner
â”‚       â””â”€â”€ 20260120_quota_system.sql  # Kvote-system tabeller og RPC
â”œâ”€â”€ scripts/                     # VerktÃ¸y og test-skript
â”‚   â”œâ”€â”€ debug_code_spacing.js
â”‚   â”œâ”€â”€ reproduce_failure.ts
â”‚   â”œâ”€â”€ test_backticks.js|ts
â”‚   â”œâ”€â”€ test_header_issue.ts
â”‚   â”œâ”€â”€ test_mermaid_repro.ts
â”‚   â”œâ”€â”€ test_nested_backticks.ts
â”‚   â””â”€â”€ test_parser.ts
â””â”€â”€ utils/                       # Generelle hjelpefunksjoner
    â”œâ”€â”€ audio.ts                 # PCM/WAV-hjelpere (lavnivÃ¥)
    â”œâ”€â”€ dom.ts                   # DOM-manipulasjon
    â””â”€â”€ fileParser.ts            # Parsing av opplastede filer (.txt gjenoppretting)
```
### NÃ¸kkelkomponenter forklart

* `services/ai/chapters.ts`: Kjernen i innholdsgenereringen. Bruker nÃ¥ "Smart Chunking" for Ã¥ bevare linjeskift i TTS-tekst, noe som er kritisk for korrekt videorendring og synkronisering.
* `services/export/video.ts`: Videomotor som bruker Canvas API og WebCodecs. Har innebygd logikk for Ã¥ splitte lange overskrifter fra brÃ¸dtekst visuelt.
* `services/export/website.ts`: Genererer en komplett HTML/CSS/JS-pakke som lar brukeren navigere i historien interaktivt.
* `services/sanitize/mermaidFixer.ts`: Intelligent "selvhelbredende" modul som oppdager syntaksfeil i Mermaid-diagrammer og fikser dem automatisk.
* `supabase/functions/_shared/utils.ts`: Delt logikk for alle Edge Functions inkludert auth, allowlist, kvote-reservering og brukslogging.
* `supabase/migrations/20260120_quota_system.sql`: Database-migrasjon med tabeller for `entitlements`, `usage_counters`, `usage_events` og atomiske RPC-funksjoner.



</details>

---

## ğŸš€ Tilgang & Installasjon

Kildekoden til Story Engine er for tiden i et privat repository (novel-planner) for Ã¥ beskytte immaterielle rettigheter (IP). Dette repoet fungerer som teknisk dokumentasjon.

For investorer, partnere eller utviklere som har fÃ¥tt tildelt tilgangsrettigheter, gjelder fÃ¸lgende oppsett:

1.  **Klon kildekode-repoet**
   (Krever autorisasjon)
    ```bash
    git clone https://github.com/engan/novel-planner.git
    cd novel-planner
    ```

2.  **Installer avhengigheter**
    ```bash
    npm install
    ```

3.  **Sett opp miljÃ¸variabler**
    Lag en `.env.local` fil i rotmappen og legg inn din API-nÃ¸kkel:
    ```env
    VITE_GEMINI_API_KEY=din_nÃ¸kkel_her
    ```

4.  **Start utviklingsserveren**
    ```bash
    npm run dev
    ```

---

## ğŸ“ Endringslogg

Kortversjon av siste endringer. Full historikk finnes i `CHANGELOG.md` (og i GitHub Releases).

### Siste endringer (arbeidsgren / story-engine-dev)
- ğŸ¬ **Video**: Mermaid-diagrammer viser nÃ¥ "Diagram er utelatt i video"-melding. Listelementer beholder **bold**/*italic* formatering. Unummererte lister bruker bullet-punkt (â€¢). Inline math ($...$) konverteres til kursiv. Fleksibel tabelldeteksjon.
- ğŸ“„ **PDF/DOCX**: Inline math stÃ¸ttes som kursiv tekst. PDF-kodeblokker har emoji-til-tekst konvertering (jsPDF-begrensning). Forbedret word-wrap i kodeblokker.
- ğŸ™ï¸ **TTS**: Stemmenavn (Charon:, etc.) fjernes kun nÃ¥r de stÃ¥r som speaker-label pÃ¥ linjestarten â€“ bevarer legitim bruk i tekst.
- ğŸ”— **Lenker**: Konsistent lenkegjengivelse i video (cyan/understrek), PDF (blÃ¥/klikkbar), og DOCX (hyperlenker). Filtrerer ut "junk" grounding-lenker.
- ğŸ–¥ï¸ **UI**: Fikset tekstoverflyt i Generation Progress-kort.
- ğŸ› ï¸ **Refaktorering**: `externalApiService.ts` â†’ `api.ts`.

> Tips: Bruk GitHub Releases for "release notes", og hold `CHANGELOG.md` som den tekniske kilden.

---

## ğŸ—ºï¸ Veikart

Vi bygger fremtidens publiseringsverktÃ¸y. Her er hva som kommer:

*   ğŸ“° **Integrasjon mot Retriever/Mediearkivet**: For dypere faktasjekk mot norske kilder.
*   ğŸ—£ï¸ **Multi-LLM Konsensus-debatt**: La flere AI-modeller diskutere en sak fÃ¸r konklusjon trekkes.
*   ğŸ—ï¸ **Pilotprosjekt med lokalavis**: Test av "Breaking News"-agent (f.eks journalist, etter avtale).
*   ğŸ“± **PWA-stÃ¸tte**: Full offline-stÃ¸tte for journalister i felt (etter avtale).

---

## ğŸµ Bonus: The Story Engine Anthem

Fordi en multimodal AI-plattform fortjener sitt eget lydspor. Tekst og melodi er generert for Ã¥ fange essensen av overgangen fra idÃ© til ferdig produkt.

> *"Story Engine / Turning one small flame to a wildfire..."*

[â–¶ï¸ **HÃ¸r sangen her (Suno)**](https://suno.com/s/bYmMmpVi77OgbCm2)

---

<details>
  <summary>ğŸ“Š</summary>
  <img src="https://komarev.com/ghpvc/?username=engan&label=V&color=0e75b6&style=flat" alt="BesÃ¸ksstatistikk" />
</details>

<div align="center">
  <p>Utviklet med â¤ï¸ i Norge</p>
  <p>Â© 2025-2026 Story Engine</p>
</div>
