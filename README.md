# Story Engine
### Den AI-drevne publiseringsplattformen.

![React](https://img.shields.io/badge/React-00599C?style=for-the-badge&logo=react&logoColor=white)
![TypeScript](https://img.shields.io/badge/TypeScript-007ACC?style=for-the-badge&logo=typescript&logoColor=white)
![Vite](https://img.shields.io/badge/Vite-646CFF?style=for-the-badge&logo=vite&logoColor=white)
![Gemini 3 Pro](https://img.shields.io/badge/Gemini_3_Pro-8E75B2?style=for-the-badge&logo=google&logoColor=white)
![Made in Norway](https://img.shields.io/badge/Made_in_Norway-A63A3A?style=for-the-badge&logo=flag-icon&logoColor=white)

![Story Engine Infographic](public/infographic.png)

> **Story Engine effektiviserer produksjonen av innhold og sikrer fakta ved hjelp av avanserte AI-agenter. Fra Ã©n idÃ© til ferdig dokument, lydbok og video â€“ kvalitetssikret.**

---

## ğŸš€ NÃ¸kkelfunksjoner

*   âœï¸ **Smart Prompt-utvidelse**: Usikker pÃ¥ hvordan du skal formulere deg? Ett klikk forvandler enkle stikkord til en rik, detaljert prosjektbeskrivelse optimalisert for at AI-en skal gi best mulig resultat.

*   âœ¨ **AI-anbefalte innstillinger**: FÃ¥ forslag til kategori, sjanger/format (155 kombinasjoner), sÃ¸k, kreativitet og diagram-frekvens - automatisk tilpasset din idÃ©.

*   ğŸ“„ **Native Dokumentgenerering**: Skaper ekte PDF, DOCX og MP3-filer direkte i nettleseren uten eksterne konverteringstjenester.

*   ğŸŒ **Interaktiv Nettside**: Eksporter prosjektet ditt som en komplett, responsiv nettside (.zip) med mÃ¸rkt tema, innholdsfortegnelse, og integrert lyd/bilde-avspilling. Ã…pnes enkelt direkte i nettleseren.

*   ğŸ¬ **Smart Video-produksjon**: Genererer videoer per kapittel med synkronisert lyd og tekst. Eksporterer som **MP4** (H.264/AAC) i **16:9** eller **9:16** (vertikal) format. Bruker "Smart Split"-teknologi for Ã¥ sikre perfekt typografi.

*   ğŸ“Š **PowerPoint-eksport (Non-Fiction)**: AI-genererte presentasjoner med oppsummerte bullet points, kapittelillustrasjoner og Mermaid-diagrammer pÃ¥ dedikerte slides.

*   ğŸ“š **EPUB E-bok**: Eksporter som universell e-bok med cover, kapittelnavigasjon og bilder â€“ klar for Apple Books, Kobo, Kindle og andre e-lesere.

*   ğŸ“‚ **Analyser hva som helst**: Start prosjektet ditt med en lydfil, video, bilde, dokument, kodefil eller et helt .zip-arkiv. AI-en forstÃ¥r innholdet og skriver "Core Idea" for deg.

*   ğŸ› ï¸ **AI-verktÃ¸ykasse for spesialoppgaver**: UtfÃ¸r avanserte oppgaver med ett klikk â€“ konverter lydfiler til undertekster (.srt), generer en komplett README.md fra et .zip-arkiv, eller trekk ut et profesjonelt sammendrag fra et langt dokument.

*   ğŸŒ **Full sprÃ¥k-kontroll**: Velg mellom auto-deteksjon eller spesifiser nÃ¸yaktig hvilket sprÃ¥k historien skal skrives pÃ¥. Inkluderer nÃ¥ oversettelse av eksisterende prosjekter.

*   ğŸ“Š **Dynamisk Diagram-frekvens**: Kontroller den visuelle tettheten med presisjon - velg hvor ofte AI-en skal generere flytskjemaer, tidslinjer og grafer.

*   ğŸ“ **Regenerer fra fil**: Last opp en tidligere generert Story Engine-fil (.txt) for Ã¥ lage nye formater som lyd, video eller nettside med den originale teksten eller oversett til et annet sprÃ¥k.

*   âš™ï¸ **Automatisk struktur**: La AI-en bestemme det optimale antallet seksjoner for historien din basert pÃ¥ kompleksitet og tema, eller velg antall seksjoner selv.

*   ğŸ™ï¸ **Velg din stemmekvalitet**: Bytt mellom to kraftige Text-to-Speech modeller for lydbÃ¸ker â€“ Gemini 2.5 Flash (rask og effektiv) eller Pro (maksimal kvalitet).

*   ğŸ¤– **Multi-Agent System**: Orkestrerer planlegging, skriving og faktasjekk gjennom spesialiserte AI-agenter som samarbeider.

*   ğŸ§¼ **Vaskemaskinen (Sanitizer)**: Automatisk rensing og validering av kode, Markdown og Mermaid-diagrammer fÃ¸r visning. "Self-healing" Mermaid-diagrammer som fikser syntaksfeil automatisk.

---

## ğŸš€ Se Story Engine i aksjon

### ğŸ§ª PrÃ¸v Appen (Beta)
Story Engine kan nÃ¥ testes pÃ¥ midlertidig server her:
ğŸ‘‰ **[https://story.neoweb.no](https://story.neoweb.no)** 

### ğŸŒ Live Interaktiv Rapport
Opplev en komplett generert leveranse direkte i nettleseren. Klikk pÃ¥ bildet under for Ã¥ utforske den interaktive nettsiden som Story Engine produserer automatisk:

<p>
  <a href="https://neoweb.no/se-walkthrough/index.html">
    <img src="https://neoweb.no/se-walkthrough/infographic.png" width="900" alt="Interaktiv Rapport Demo"/>
  </a>
  <br/>
  <a href="https://neoweb.no/se-walkthrough/index.html"><strong>Ã…pne Interaktiv Demo â”</strong></a>
</p>

---

### ğŸ—ºï¸ Videogjennomgang
> ğŸ’¡ **Klikk pÃ¥ bildene for Ã¥ se videoene direkte fra vÃ¥r server**

<table>
  <tr>
    <td>
      <strong>Seksjon 1: Velkommen til Story Engine</strong><br/>
      <a href="https://neoweb.no/se-walkthrough/chapter-1.webm">
        <img src="https://neoweb.no/se-walkthrough/poster-1.png" width="420" alt="Seksjon 1"/>
      </a><br/>
      Introduksjon til Story Engine og dets muligheter.
    </td>
    <td>
      <strong>Seksjon 2: Slik fungerer det</strong><br/>
      <a href="https://neoweb.no/se-walkthrough/chapter-2.webm">
        <img src="https://neoweb.no/se-walkthrough/poster-2.png" width="420" alt="Seksjon 2"/>
      </a><br/>
      Steg-for-steg gjennomgang av arbeidsflyten.
    </td>
  </tr>
  <tr>
    <td>
      <strong>Seksjon 3: NÃ¸kkelfunksjoner</strong><br/>
      <a href="https://neoweb.no/se-walkthrough/chapter-3.webm">
        <img src="https://neoweb.no/se-walkthrough/poster-3.png" width="420" alt="Seksjon 3"/>
      </a><br/>
      Deep dive i avanserte funksjoner.
    </td>
    <td>
      <strong>Seksjon 4: Teknologi og Sikkerhet</strong><br/>
      <a href="https://neoweb.no/se-walkthrough/chapter-4.webm">
        <img src="https://neoweb.no/se-walkthrough/poster-4.png" width="420" alt="Seksjon 4"/>
      </a><br/>
      Teknisk arkitektur og sikkerhetsprinsipper.
    </td>
  </tr>
</table>

### ğŸ–¥ï¸ Visuell Omvisning App
MÃ¸tet med brukeren â€“ rent, moderne og inviterende.

![Landingsside](public/app-hero-eng.png)

<details>
<summary><strong>Klikk for Ã¥ se Story Engine app</strong></summary>

### Startside app
Etter landingssiden â€“ moderne og stilrent panel.
![Startside app](public/story-engine.png)

### Alternativt smal skjermbredde
Skriv inn dine nye ideer umiddelbart pÃ¥ din telefon. 

![Alternativt smal skjermbredde](public/story-engine-small.png)
</details>

<details>
<summary><strong>Klikk for Ã¥ se genereringen i sanntid</strong></summary>

### Generation Progress
Noen trinn fÃ¸r genereringen, her foregÃ¥r researchingen.
![Generation Progress](public/researching.png)

Hvor magien skjer. Her ser brukeren innholdet bli skapt i sanntid, med levende oppdateringer.
![Generation Progress](public/generation-progress.jpg)
</details>

---

## ğŸ—ï¸ Teknisk Arkitektur

### Dataflyt (Input â†’ Eksport)

Dataflyten er delt i to separate diagrammer for bedre lesbarhet.

<details>
<summary><strong>Klikk for Ã¥ se Dataflyt Del 1 (Input â†’ Generering)</strong></summary>

### Dataflyt Del 1: Input â†’ Generering

Dette diagrammet dekker input, analyse, planlegging og innholdsgenerering fram til ferdig generert payload.
```mermaid
graph TD
    Entry((("ğŸš€ App Start")))
    Entry --> LandingPage["ğŸ  Landing Page<br/><i>LandingPage.tsx</i>"]
    LandingPage --> UserStart((("ğŸ‘¤ Bruker")))

    subgraph InputSources ["ğŸ“¥ INPUT KILDER"]
        direction TB
        IdeaInput["ğŸ“ Core Idea"]
        FileInput["ğŸ“ Fil Upload"]
        URLInput["ğŸŒ URL Analyse"]
        PlanFile["ğŸ“„ .txt Plan"]
    end
    UserStart -->|"Velger kilde"| InputSources

    subgraph Analysis ["ğŸ” ANALYSE & ANBEFALINGER"]
        direction TB
        CoreIdea["ğŸ’¡ Core Idea"]
        UI["ğŸ¨ IntroView"]
        AIRecommend["ğŸ¤– getRecommendedSettingsHybrid()"]
        SuggestPrompt["âœ¨ enhanceUserIdeaHybrid()"]
        FileAnalyzer["âš™ï¸ fileExtract.ts"]
        URLAnalyzer["ğŸ”— api.ts"]
        FileParser["ğŸ“‘ fileParser.ts"]
        SharedPromptSuggest["ğŸ§© shared/prompts<br/><i>suggest builders</i>"]
        EdgeSuggestPrompt["âš™ï¸ ai-suggest-prompt"]
        EdgeSuggestSettings["âš™ï¸ ai-suggest-settings"]
        EdgeAnalyzeFile["âš™ï¸ ai-analyze-file"]
        EdgeUrlAnalyze["âš™ï¸ url-analyze"]
        GeminiAnalyze["ğŸ¤– Gemini API<br/><i>3-flash/pro</i>"]
    end

    IdeaInput --> AIRecommend
    IdeaInput --> SuggestPrompt
    SuggestPrompt --> EdgeSuggestPrompt
    EdgeSuggestPrompt --> SharedPromptSuggest
    EdgeSuggestPrompt --> GeminiAnalyze
    CoreIdea --> AIRecommend
    AIRecommend --> EdgeSuggestSettings
    EdgeSuggestSettings --> SharedPromptSuggest
    EdgeSuggestSettings --> GeminiAnalyze
    GeminiAnalyze --> CoreIdea
    EdgeSuggestSettings --> UI

    FileInput --> FileAnalyzer
    FileAnalyzer --> EdgeAnalyzeFile
    EdgeAnalyzeFile --> GeminiAnalyze
    URLInput --> URLAnalyzer
    URLAnalyzer --> EdgeUrlAnalyze
    EdgeUrlAnalyze --> GeminiAnalyze
    PlanFile --> FileParser --> PlanReady["ğŸ“‹ NovelPlan<br/><i>fra fil</i>"]

    subgraph Planning ["ğŸ“ PLANLEGGING"]
        direction TB
        PlanningLogic{"ğŸ¤” Har vi plan?"}
        PlanGenerator["ğŸ“ generateNovelPlanHybrid()"]
        SharedPromptPlan["ğŸ§© shared/prompts<br/><i>planPrompt.ts</i>"]
        EdgePlan["âš™ï¸ ai-plan"]
        GeminiPlan["ğŸ¤– Gemini API<br/><i>3-pro</i>"]
        SearchDecision{"ğŸ” Google Search?"}
        SearchAPI["ğŸŒ Grounding + Citations"]
    end

    UI --> PlanningLogic
    PlanningLogic -->|"Ja"| PlanReady
    PlanningLogic -->|"Nei"| PlanGenerator
    PlanGenerator --> SharedPromptPlan
    SharedPromptPlan --> EdgePlan
    EdgePlan --> GeminiPlan
    EdgePlan --> SearchDecision
    SearchDecision -->|"Ja"| SearchAPI --> EdgePlan
    SearchDecision -->|"Nei"| EdgePlan
    EdgePlan --> PlanReady

    subgraph ContentFlow ["âœï¸ GENERERING + SANITIZE + ADD-ONS"]
        direction TB
        EdgeImageCover["âš™ï¸ ai-image (cover)"]
        ImageGen["ğŸ¨ Imagen 4.0"]
        PlanWithCover["ğŸ“– Plan + coverImageUrl"]
        ChapterGen["ğŸ“š generateChapterBatch()"]
        PromptService3["ğŸ“‹ getBaseChapterPrompt()"]
        SharedPromptSection["ğŸ§© shared/prompts<br/><i>sectionPrompt.ts</i>"]
        EdgeSection["âš™ï¸ ai-generate-section<br/><i>SSE</i>"]
        GeminiSection["ğŸ¤– Gemini Streaming"]
        StreamHandler["ğŸ“¡ chapters.ts"]
        RawMD["ğŸ“„ RÃ¥ MD"]
        Fix1["ğŸ”§ ContentSanitizer"]
        Fix2["âœ… mermaidFixer"]
        MermaidDecision{"ğŸ“Š Mermaid OK?"}
        EdgeMermaidFix["âš™ï¸ ai-mermaid-fix"]
        SharedPromptFix["ğŸ§© mermaidFixPrompt.ts"]
        GeminiFix["ğŸ¤– Mermaid fix"]
        CleanMD["âœ¨ Ren MD"]
        AddOnProcessor["âš¡ processChapterAddOns()"]
        EdgeImageChapter["âš™ï¸ ai-image (chapter)"]
        EdgeScript["âš™ï¸ ai-script-convert"]
        EdgeTTS["âš™ï¸ ai-tts"]
        FinalChapter["ğŸ“– GeneratedChapter"]
        GenerationPayload["ğŸ’¾ Payload til Del 2"]
    end

    PlanReady --> EdgeImageCover
    EdgeImageCover --> ImageGen
    ImageGen --> EdgeImageCover
    EdgeImageCover --> PlanWithCover
    PlanWithCover --> ChapterGen
    ChapterGen --> PromptService3
    PromptService3 --> SharedPromptSection
    SharedPromptSection --> EdgeSection
    EdgeSection --> GeminiSection
    GeminiSection --> EdgeSection
    EdgeSection --> StreamHandler
    StreamHandler --> RawMD
    RawMD --> Fix1
    Fix1 --> Fix2
    Fix2 --> MermaidDecision
    MermaidDecision -->|"Ja"| CleanMD
    MermaidDecision -->|"Nei"| EdgeMermaidFix
    EdgeMermaidFix --> SharedPromptFix
    SharedPromptFix --> GeminiFix
    GeminiFix --> EdgeMermaidFix
    EdgeMermaidFix --> Fix2
    CleanMD --> AddOnProcessor
    AddOnProcessor --> EdgeImageChapter
    AddOnProcessor --> EdgeScript
    EdgeScript --> EdgeTTS
    AddOnProcessor --> FinalChapter
    EdgeImageChapter --> FinalChapter
    EdgeTTS --> FinalChapter
    FinalChapter --> GenerationPayload
    PlanWithCover --> GenerationPayload

    classDef userNode fill:#fef3c7,stroke:#d97706,stroke-width:3px,color:#92400e
    classDef landingNode fill:#fce7f3,stroke:#be185d,stroke-width:2px,color:#9d174d
    classDef apiNode fill:#dbeafe,stroke:#2563eb,stroke-width:2px,color:#1e40af
    classDef processNode fill:#f3e8ff,stroke:#7c3aed,stroke-width:2px,color:#5b21b6
    classDef serviceNode fill:#e0e7ff,stroke:#4f46e5,stroke-width:2px,color:#3730a3
    classDef stateNode fill:#dcfce7,stroke:#16a34a,stroke-width:3px,color:#166534
    classDef decisionNode fill:#fff7ed,stroke:#ea580c,stroke-width:2px,color:#c2410c
    classDef sanitizerNode fill:#e0f2fe,stroke:#0284c7,stroke-width:2px,color:#075985

    class Entry,UserStart userNode
    class LandingPage landingNode
    class GeminiAnalyze,GeminiPlan,SearchAPI,ImageGen,GeminiSection,GeminiFix apiNode
    class SuggestPrompt,AIRecommend,PlanGenerator,ChapterGen,StreamHandler,AddOnProcessor processNode
    class PromptService3,FileAnalyzer,URLAnalyzer,FileParser,EdgeSuggestPrompt,EdgeSuggestSettings,EdgeAnalyzeFile,EdgeUrlAnalyze,EdgePlan,SharedPromptSuggest,SharedPromptPlan,SharedPromptSection,EdgeSection,EdgeImageCover,EdgeImageChapter,EdgeMermaidFix,SharedPromptFix,EdgeScript,EdgeTTS serviceNode
    class CoreIdea,PlanReady,PlanWithCover,FinalChapter,GenerationPayload,UI stateNode
    class PlanningLogic,SearchDecision,MermaidDecision decisionNode
    class RawMD,Fix1,Fix2,CleanMD sanitizerNode
```
</details>

<details>
<summary><strong>Klikk for Ã¥ se Dataflyt Del 2 (State â†’ Eksport)</strong></summary>

### Dataflyt Del 2: State â†’ Eksport

Dette diagrammet dekker state/sporing, visning og alle eksportformatene.
```mermaid
graph TD
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% ğŸ“± STORY ENGINE - DEL 2 (STATE â†’ EKSPORT)
    %% Oppdatert: Februar 2026
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    GenerationPayload["ğŸ“¥ Fra Del 1<br/><i>Plan + Chapters + Audio + Images</i>"]
    QuotaUsage["ğŸ’³ Credits/Kvoter<br/><i>Edge _shared/utils.ts</i>"]

    subgraph StateTracking ["ğŸ’¾ STATE & SPORING"]
        direction LR
        AppState[("App State<br/><i>React</i>")]
        UsageMetrics["ğŸ“Š UsageMetrics<br/><i>Tokens/Images/Audio</i>"]
    end

    GenerationPayload --> AppState
    GenerationPayload -.-> QuotaUsage
    QuotaUsage --> UsageMetrics
    AppState --> UsageMetrics

    Viewer["ğŸ–¥ï¸ ContentRenderer<br/><i>react-markdown + Mermaid</i>"]
    Screen["ğŸ“º GenerationView<br/><i>Live + Yellow text</i>"]
    UserEnd((("ğŸ‘¤ Bruker")))
    DownloadBtn["â¬‡ï¸ DownloadModal<br/><i>Format + Progress</i>"]
    FormatChoice{"ğŸ“ Format?"}

    AppState --> Viewer --> Screen
    UserEnd -.->|"Ser dokument"| Screen
    UserEnd -->|"Last Ned"| DownloadBtn --> FormatChoice

    subgraph ExportService ["ğŸ“¤ EKSPORT SERVICE"]
        direction TB
        DLService["ğŸ”§ downloadService"]
        ContentParse["ğŸ“‘ ContentParser<br/><i>MD â†’ Blokker</i>"]
        ExportModules["ğŸ“¦ Export Modules<br/><i>docx/pdf/video/website</i>"]
        FullMD["ğŸ“„ Full Markdown<br/><i>YAML + Innhold</i>"]
        DLService --> ContentParse
        DLService --> ExportModules
        DLService --> FullMD
    end

    AppState -->|"NovelPlan + Chapters"| DLService
    UsageMetrics -->|"Produksjonsrapport"| DLService

    subgraph ExportFormats ["ğŸ’¾ EKSPORT FORMATER"]
        direction TB
        ExportTXT["ğŸ“„ .txt<br/><i>YAML + Markdown</i>"]
        GeneratePDF["ğŸ“• PDF Generator<br/><i>jsPDF + Bold/Italic</i>"]
        ExportPDF["ğŸ“• .pdf<br/><i>A4 + Mermaid PNG</i>"]
        GenerateDOCX["ğŸ“˜ DOCX Generator<br/><i>docx + Numbered lists</i>"]
        ExportDOCX["ğŸ“˜ .docx<br/><i>Native Word</i>"]
        GenerateMP3["ğŸµ Audio Processor<br/><i>MP3/WAV valg</i>"]
        ExportMP3["ğŸµ .zip<br/><i>MP3 (64kbps) eller WAV</i>"]
        GenerateWebM["ğŸ¬ Video Processor<br/><i>MP4 H.264/AAC</i>"]
        ExportWebM["ğŸ¬ .zip<br/><i>MP4 (16:9 / 9:16)</i>"]
        GenerateWebsite["ğŸŒ Web Generator<br/><i>HTML/CSS/JS Bundle</i>"]
        ExportWebsite["ğŸŒ .zip<br/><i>Interaktiv side</i>"]
        GeneratePPTX["ğŸ“Š PPTX Generator<br/><i>AI Summarize + PptxGenJS</i>"]
        ExportPPTX["ğŸ“Š .pptx<br/><i>Non-Fiction presentasjon</i>"]
        GenerateEPUB["ğŸ“š EPUB Generator<br/><i>XHTML + Cover</i>"]
        ExportEPUB["ğŸ“š .epub<br/><i>Universell e-bok</i>"]
    end

    FormatChoice -->|"TXT"| ExportTXT
    FullMD --> ExportTXT

    FormatChoice -->|"PDF"| GeneratePDF
    ContentParse --> GeneratePDF
    GeneratePDF --> ExportPDF

    FormatChoice -->|"DOCX"| GenerateDOCX
    ContentParse --> GenerateDOCX
    GenerateDOCX --> ExportDOCX

    FormatChoice -->|"MP3"| GenerateMP3
    AppState -->|"audioContent"| GenerateMP3
    GenerateMP3 --> ExportMP3

    FormatChoice -->|"MP4 Video"| GenerateWebM
    AppState -->|"audio + image"| GenerateWebM
    GenerateWebM --> ExportWebM

    FormatChoice -->|"Nettside"| GenerateWebsite
    AppState -->|"Plan + Chapters"| GenerateWebsite
    GenerateWebsite --> ExportWebsite

    FormatChoice -->|"PPTX"| GeneratePPTX
    AppState -->|"Plan + AI Summary"| GeneratePPTX
    GeneratePPTX --> ExportPPTX

    FormatChoice -->|"EPUB"| GenerateEPUB
    ContentParse --> GenerateEPUB
    GenerateEPUB --> ExportEPUB

    classDef userNode fill:#fef3c7,stroke:#d97706,stroke-width:3px,color:#92400e
    classDef apiNode fill:#dbeafe,stroke:#2563eb,stroke-width:2px,color:#1e40af
    classDef processNode fill:#f3e8ff,stroke:#7c3aed,stroke-width:2px,color:#5b21b6
    classDef serviceNode fill:#e0e7ff,stroke:#4f46e5,stroke-width:2px,color:#3730a3
    classDef stateNode fill:#dcfce7,stroke:#16a34a,stroke-width:3px,color:#166534
    classDef exportNode fill:#fce7f3,stroke:#db2777,stroke-width:2px,color:#9d174d
    classDef decisionNode fill:#fff7ed,stroke:#ea580c,stroke-width:2px,color:#c2410c
    classDef viewNode fill:#f5f3ff,stroke:#7c3aed,stroke-width:2px,color:#5b21b6
    classDef metricsNode fill:#fef9c3,stroke:#ca8a04,stroke-width:2px,color:#854d0e

    class UserEnd userNode
    class Viewer,Screen viewNode
    class DLService,ContentParse,ExportModules serviceNode
    class AppState,GenerationPayload stateNode
    class QuotaUsage,UsageMetrics metricsNode
    class FormatChoice decisionNode
    class ExportTXT,ExportPDF,ExportDOCX,ExportMP3,ExportWebM,ExportWebsite,ExportPPTX,ExportEPUB,GeneratePDF,GenerateDOCX,GenerateMP3,GenerateWebM,GenerateWebsite,GeneratePPTX,GenerateEPUB,FullMD,DownloadBtn exportNode
```
</details>

<details>
<summary><strong>Klikk for Ã¥ se Sekvensdiagram (Interaksjon)</strong></summary>

### Sekvensdiagram (Interaksjon)

Hvordan frontend kommuniserer med AI-modellene og hÃ¥ndterer asynkrone strÃ¸mmer.

```mermaid
%%{init: {
  'theme': 'base',
  'themeVariables': {
    'primaryColor': '#6366f1',
    'primaryTextColor': '#ffffff',
    'primaryBorderColor': '#4f46e5',
    'secondaryColor': '#10b981',
    'tertiaryColor': '#f0f9ff',
    'lineColor': '#6366f1',
    'noteTextColor': '#1e293b',
    'noteBkgColor': '#fef3c7',
    'noteBorderColor': '#f59e0b',
    'actorTextColor': '#1e293b',
    'actorBkg': '#e0e7ff',
    'actorBorder': '#6366f1',
    'activationBkgColor': '#c7d2fe',
    'activationBorderColor': '#4f46e5',
    'sequenceNumberColor': '#ffffff'
  },
  'sequence': {
    'mirrorActors': false,
    'messageAlign': 'center',
    'width': 180,
    'useMaxWidth': true
  }
}}%%

sequenceDiagram
    autonumber
    
    box rgba(99, 102, 241, 0.1) ğŸ¯ KLIENT
        participant User as ğŸ‘¤ Bruker
        participant FE as ğŸ–¥ï¸ Frontend
        participant San as ğŸ§¼ Sanitizer
        participant DL as ğŸ“¦ Download/Export
    end
    
    box rgba(16, 185, 129, 0.1) â˜ï¸ EDGE
        participant Edge as âš™ï¸ Supabase Edge Functions
    end
    
    box rgba(245, 158, 11, 0.1) ğŸ§  MODELLER
        participant Gemini as âš¡ Gemini API
        participant Search as ğŸ” Google Search
        participant Imagen as ğŸ¨ Imagen
    end

    Note over User,Imagen: ğŸ¯ FASE 1: Input & AI-anbefalinger
    
    User->>+FE: ğŸ“ Input: idÃ©, fil eller URL
    alt Filanalyse
        FE->>+Edge: POST ai-analyze-file
        Edge->>+Gemini: Multimodal analyse
        Gemini-->>-Edge: Analyse-resultat
        Edge-->>-FE: Core Idea / sammendrag
    else URL-analyse
        FE->>+Edge: POST url-analyze
        Edge-->>-FE: Innhold / sammendrag
    end
    FE->>+Edge: POST ai-suggest-settings
    Edge->>Gemini: Prompt fra shared/prompts
    Gemini-->>Edge: Settings-forslag
    Edge-->>-FE: category/genre/creativity/grounding

    Note over User,Imagen: ğŸ“ FASE 2: Planlegging og cover
    
    User->>FE: âœ… Godkjenn innstillinger
    FE->>+Edge: POST ai-plan
    Note over Edge: buildPlanPrompt() fra shared/prompts
    
    alt Grounding aktivert
        Edge->>+Search: Hent kilder/fakta
        Search-->>-Edge: Grounded data
    end
    
    Edge->>+Gemini: Generer plan JSON
    Gemini-->>-Edge: NovelPlan + citations
    Edge-->>-FE: Plan-respons
    FE->>+Edge: POST ai-image (cover)
    Edge->>+Imagen: Generer cover
    Imagen-->>-Edge: Base64 bilde
    Edge-->>-FE: coverImageUrl

    Note over User,Imagen: âœï¸ FASE 3: Seksjonsgenerering (SSE)
    
    loop Per seksjon
        FE->>+Edge: POST ai-generate-section (stream)
        Note over Edge: buildGenerateSectionPrompt() fra shared/prompts
        Edge->>+Gemini: streamGenerateContent
        loop Per chunk
            Gemini-->>Edge: Markdown chunk
            Edge-->>FE: SSE event chunk
            FE->>San: Rens + valider Mermaid
            opt Mermaid krever AI-fiks
                San->>+Edge: POST ai-mermaid-fix
                Edge->>Gemini: Fix-prompt (shared/prompts)
                Gemini-->>Edge: Fikset diagram
                Edge-->>-San: Valid Mermaid
            end
            San-->>FE: Ren output
            FE-->>User: Live oppdatering
        end
        Gemini-->>-Edge: Seksjon ferdig
        Edge-->>-FE: DONE event
    end
    
    Note over User,Imagen: ğŸ FASE 4: Add-ons
    opt Illustrasjoner / TTS
        FE->>+Edge: POST ai-image (kapittel)
        Edge->>Imagen: Generer illustrasjon
        Imagen-->>Edge: Base64 bilde
        Edge-->>-FE: chapter image
        FE->>+Edge: POST ai-script-convert / ai-tts
        Edge->>Gemini: Script/TTS behandling
        Gemini-->>Edge: Audio/script-data
        Edge-->>-FE: Audio chunks
    end

    Note over User,DL: ğŸ“¥ FASE 5: Eksport
    
    User->>FE: ğŸ“ Velg eksportformat
    FE->>DL: Parse markdown + bygg filer
    
    DL-->>User: TXT / PDF / DOCX / MP3 / MP4 / ZIP / PPTX / EPUB
```
</details>

---

## ğŸ“‚ Filstruktur & Modul-analyse

<details>
<summary><strong>Klikk for filstruktur</strong></summary>

Prosjektet har gjennomgÃ¥tt en omfattende refaktorering for Ã¥ Ã¸ke vedlikeholdbarhet og skalerbarhet. Vi bruker nÃ¥ en tydelig domenestruktur under `services`, samt et delt prompt-lag i `shared/prompts` for Ã¥ hindre prompt-drift mellom frontend og Edge Functions.

```text
.
â”œâ”€â”€ App.tsx                                   # Global state, view-ruting og kostnadssporing
â”œâ”€â”€ README.md                                 # Dokumentasjon
â”œâ”€â”€ CHANGELOG.md                              # Endringslogg
â”œâ”€â”€ ROADMAP.md                                # Veikart og fremtidsplaner
â”œâ”€â”€ constants.ts                              # Globale konstanter (stemmer, stiler)
â”œâ”€â”€ types.ts                                  # TypeScript definisjoner for hele applikasjonen
â”œâ”€â”€ genres.ts                                 # Definisjoner av hovedsjangre og kategorier
â”œâ”€â”€ genreOptions.ts                           # Kontekstuelle sub-options (faktasjekk, lengde, etc.)
â”œâ”€â”€ genreUtils.ts                             # Delte sjanger-hjelpere (fiction/non-fiction checks)
â”œâ”€â”€ languages.ts                              # StÃ¸ttede sprÃ¥k for I/O
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ Icons.tsx                             # Ikoner (SVG)
â”‚   â”œâ”€â”€ MermaidDebugPage.tsx                  # Debug side for Mermaid
â”‚   â”œâ”€â”€ OnboardingModal.tsx                   # FÃ¸rstegangs onboarding
â”‚   â”œâ”€â”€ ParserTest.tsx                        # Test-komponent for parser
â”‚   â”œâ”€â”€ landing/                              # Landingsside komponenter
â”‚   â”‚   â””â”€â”€ LandingPage.tsx                   # Hovedinngang / Hero-seksjon
â”‚   â”œâ”€â”€ ui/                                   # Gjenbrukbare UI-komponenter
â”‚   â”‚   â”œâ”€â”€ ContentRenderer.tsx               # Markdown/Mermaid renderer (ReactMarkdown)
â”‚   â”‚   â”œâ”€â”€ DownloadModal.tsx                 # Modal for valg av eksportformat
â”‚   â”‚   â”œâ”€â”€ ErrorBoundary.tsx                 # FeilhÃ¥ndtering
â”‚   â”‚   â”œâ”€â”€ LoadingView.tsx                   # Animerte laste-steg (Analyzing -> Finalizing)
â”‚   â”‚   â”œâ”€â”€ LogViewer.tsx                     # Debug-konsoll i UI
â”‚   â”‚   â”œâ”€â”€ Mermaid.tsx                       # Wrapper for Mermaid-diagrammer
â”‚   â”‚   â”œâ”€â”€ PlanningStepper.tsx               # Visuell fremdriftsindikator
â”‚   â”‚   â”œâ”€â”€ ResearchSourcesBox.tsx            # Visning av Google Search-kilder
â”‚   â”‚   â””â”€â”€ SettingsModal.tsx                 # Avanserte innstillinger (Logger, Terskelverdier)
â”‚   â””â”€â”€ views/                                # Hovedvisninger (States)
â”‚       â”œâ”€â”€ AdminUsersView.tsx                # Egen admin-visning for brukerstyring
â”‚       â”œâ”€â”€ AltIntroDesignView.tsx            # Alternativ intro-layout / design
â”‚       â”œâ”€â”€ DashboardView.tsx                 # Brukerdashboard og prosjektoversikt
â”‚       â”œâ”€â”€ ProjectsView.tsx                  # Prosjektliste og prosjektstyring
â”‚       â”œâ”€â”€ LoginView.tsx                     # Innlogging og autentisering
â”‚       â”œâ”€â”€ WaitlistView.tsx                  # Venteliste og early access
â”‚       â”œâ”€â”€ IntroView.tsx                     # Input, filanalyse, drag-n-drop
â”‚       â”œâ”€â”€ CastingView.tsx                   # Karakteroversikt og stemmevalg
â”‚       â”œâ”€â”€ GenerationView.tsx                # Live streaming av innhold
â”‚       â””â”€â”€ CompleteView.tsx                  # Ferdig resultat, avspilling og regenerering
â”œâ”€â”€ scripts/                                  # VerktÃ¸y og test-skript
â”‚   â”œâ”€â”€ check-prompt-drift.mjs                # CI-guard mot inline core-prompts i Edge Functions
â”‚   â”œâ”€â”€ smoke-prompt-builders.ts              # Smoke-test av shared prompt-builders
â”‚   â”œâ”€â”€ verify_quotas.ts                      # Kvote/credit test mot Edge Functions
â”‚   â””â”€â”€ ...                                   # Repro/parse/test hjelpeskript
â”œâ”€â”€ services/                                 # FORRETNINGSLOGIKK (MODULÃ†R)
â”‚   â”œâ”€â”€ ContentParser.ts                      # AST-parser som konverterer MD til blokker
â”‚   â”œâ”€â”€ ContentSanitizer.ts                   # "Vaskemaskinen" (Regex-rensing, header-fiks)
â”‚   â”œâ”€â”€ documentStyles.ts                     # Fasade for styles/index.ts
â”‚   â”œâ”€â”€ downloadService.ts                    # Fasade for export/index.ts
â”‚   â”œâ”€â”€ api.ts                                # URL-analyse og ekstern API-kommunikasjon
â”‚   â”œâ”€â”€ auth.ts                               # Autentiseringslogikk
â”‚   â”œâ”€â”€ formatConstants.ts                    # Konstanter for overskriftsformater
â”‚   â”œâ”€â”€ geminiService.ts                      # Fasade for ai/index.ts
â”‚   â”œâ”€â”€ modelPricing.ts                       # Prismodeller for Gemini/Imagen
â”‚   â”œâ”€â”€ prompts.ts                            # Stabil offentlig entrypoint (barrel re-export)
â”‚   â”œâ”€â”€ supabaseApi.ts                        # Klient for Supabase Edge Functions
â”‚   â”œâ”€â”€ supabaseClient.ts                     # Supabase autentisering og oppsett
â”‚   â”œâ”€â”€ ai/                                   # AI-integrasjon (Google GenAI)
â”‚   â”‚   â”œâ”€â”€ audioHelpers.ts                   # PCM/Base64 hjelpere
â”‚   â”‚   â”œâ”€â”€ chapters.ts                       # Generering av kapitler (tekst + add-ons)
â”‚   â”‚   â”œâ”€â”€ config.ts                         # Konfigurasjon (tokens, sikkerhet)
â”‚   â”‚   â”œâ”€â”€ fileExtract.ts                    # Filanalyse (DOCX, PDF, Code, Images)
â”‚   â”‚   â”œâ”€â”€ imageGenerator.ts                 # Bildegenerering via Supabase/API-lag
â”‚   â”‚   â”œâ”€â”€ imagen.ts                         # Bildegenerering (Imagen & Gemini)
â”‚   â”‚   â”œâ”€â”€ index.ts                          # EksportÃ¸r
â”‚   â”‚   â”œâ”€â”€ retry.ts                          # FeilhÃ¥ndtering og retry-logikk
â”‚   â”‚   â”œâ”€â”€ schemas.ts                        # Zod/JSON schemas for AI output
â”‚   â”‚   â”œâ”€â”€ summarize.ts                      # AI-oppsummering for PPTX bullet points
â”‚   â”‚   â”œâ”€â”€ tts.ts                            # Tekst-til-tale logikk (Gemini)
â”‚   â”‚   â””â”€â”€ utils.ts                          # Delte AI-hjelpere
â”‚   â”œâ”€â”€ aiHybrid.ts                           # Edge-first orkestrering (lokal fallback fjernet)
â”‚   â”œâ”€â”€ export/                               # Eksport-moduler
â”‚   â”‚   â”œâ”€â”€ docx.ts                           # DOCX-generering
â”‚   â”‚   â”œâ”€â”€ epub.ts                           # EPUB 3 e-bok generering (XHTML + Cover)
â”‚   â”‚   â”œâ”€â”€ index.ts                          # EksportÃ¸r
â”‚   â”‚   â”œâ”€â”€ markdown.ts                       # Markdown-generering
â”‚   â”‚   â”œâ”€â”€ mp3.ts                            # Lyd-sammenstilling (MP3 64kbps / WAV)
â”‚   â”‚   â”œâ”€â”€ pdf.ts                            # PDF-generering med avansert formatering
â”‚   â”‚   â”œâ”€â”€ pptx.ts                           # PowerPoint-generering (Non-Fiction)
â”‚   â”‚   â”œâ”€â”€ utils.ts                          # Delte eksport-hjelpere (Mermaid render)
â”‚   â”‚   â”œâ”€â”€ video.ts                          # Videorendring (MP4 H.264/AAC, 16:9 / 9:16) med "Smart Split"
â”‚   â”‚   â””â”€â”€ website.ts                        # Interaktiv nettside-pakking (ZIP)
â”‚   â”œâ”€â”€ format/                               # Tekstformatering
â”‚   â”‚   â””â”€â”€ sectionHeaders.ts                 # HÃ¥ndtering av kapitteloverskrifter og sprÃ¥k
â”‚   â”œâ”€â”€ i18n/                                 # Internasjonalisering
â”‚   â”‚   â””â”€â”€ translations.ts                   # Oversettelser (NO/EN) for UI og eksport
â”‚   â”œâ”€â”€ prompts/                              # Lokale prompt-moduler (split refaktor)
â”‚   â”‚   â”œâ”€â”€ README.md                         # Modulgrense + safe refactor-regler
â”‚   â”‚   â”œâ”€â”€ core.ts                           # Delte lokale prompt-konstanter/hjelpere
â”‚   â”‚   â”œâ”€â”€ referencePrompts.ts               # Fil-/media-analyse prompts
â”‚   â”‚   â”œâ”€â”€ settingsPrompts.ts                # Settings + enhance-idea prompts
â”‚   â”‚   â”œâ”€â”€ novelPlanPrompts.ts               # Plan/story prompts
â”‚   â”‚   â”œâ”€â”€ chapterPrompts.ts                 # Chapter/section + export/QA/TTS prompts
â”‚   â”‚   â””â”€â”€ fragments/                        # Re-export av shared fragments
â”‚   â”‚       â”œâ”€â”€ markdownRules.ts              # MD-regler (fra shared/prompts)
â”‚   â”‚       â”œâ”€â”€ mermaidRules.ts               # Mermaid-regler (fra shared/prompts)
â”‚   â”‚       â”œâ”€â”€ mermaidSyntaxV11.ts           # Mermaid v11 syntaks (shared)
â”‚   â”‚       â””â”€â”€ professionalVisualization.ts  # Visualiseringsstrategi (shared)
â”‚   â”œâ”€â”€ sanitize/                             # Rens og validering
â”‚   â”‚   â””â”€â”€ mermaidFixer.ts                   # Self-healing Mermaid logikk
â”‚   â””â”€â”€ styles/                               # Stildefinisjoner
â”‚       â”œâ”€â”€ config.ts                         # Globale stilvariabler
â”‚       â”œâ”€â”€ docx.ts                           # DOCX-spesifikke stiler
â”‚       â”œâ”€â”€ helpers.ts                        # Hjelpefunksjoner for farger/stÃ¸rrelser
â”‚       â”œâ”€â”€ index.ts                          # EksportÃ¸r
â”‚       â”œâ”€â”€ pdf.ts                            # PDF-spesifikke stiler
â”‚       â”œâ”€â”€ types.ts                          # Type-definisjoner for stiler
â”‚       â””â”€â”€ units.ts                          # Enhetskonvertering (mm, px, pt)
â”œâ”€â”€ shared/                                   # Delt kode mellom frontend og Edge Functions
â”‚   â””â”€â”€ prompts/                              # Prompt source-of-truth (core generation flows)
â”‚       â”œâ”€â”€ builders/                         # Prompt-builders for Edge flows
â”‚       â”‚   â”œâ”€â”€ sectionPrompt.ts              # ai-generate-section
â”‚       â”‚   â”œâ”€â”€ planPrompt.ts                 # ai-plan
â”‚       â”‚   â”œâ”€â”€ suggestPrompt.ts              # ai-suggest-prompt
â”‚       â”‚   â”œâ”€â”€ suggestSettingsPrompt.ts      # ai-suggest-settings
â”‚       â”‚   â””â”€â”€ mermaidFixPrompt.ts           # ai-mermaid-fix
â”‚       â”œâ”€â”€ fragments/                        # Delte prompt-fragmenter
â”‚       â”‚   â”œâ”€â”€ markdownRules.ts              # Markdown-regler
â”‚       â”‚   â”œâ”€â”€ mermaidRules.ts               # Mermaid-regler
â”‚       â”‚   â”œâ”€â”€ mermaidSyntaxV11.ts           # Mermaid v11 syntaks
â”‚       â”‚   â””â”€â”€ professionalVisualization.ts  # Visualisering
â”‚       â””â”€â”€ index.ts                          # Stabil eksportflate
â”œâ”€â”€ supabase/                                 # SUPABASE BACKEND (Edge Functions + DB)
â”‚   â”œâ”€â”€ config.toml                           # Supabase lokal konfigurasjon
â”‚   â”œâ”€â”€ deno.json                             # Deno konfigurasjon for Edge Functions
â”‚   â”œâ”€â”€ functions/
â”‚   â”‚   â”œâ”€â”€ _shared/                          # Delt logikk for alle Edge Functions
â”‚   â”‚   â”‚   â”œâ”€â”€ utils.ts                      # Auth, allowlist, kvote/credit-hÃ¥ndtering
â”‚   â”‚   â”‚   â”œâ”€â”€ pricing.ts                    # Pris- og kredittkonvertering (server-side)
â”‚   â”‚   â”‚   â”œâ”€â”€ rateLimit.ts                  # Upstash Redis rate limiting
â”‚   â”‚   â”‚   â”œâ”€â”€ genres.ts                     # Delt sjangerdata
â”‚   â”‚   â”‚   â””â”€â”€ genreOptions.ts               # Delt sub-option data
â”‚   â”‚   â”œâ”€â”€ ai-admin-adjust-credits/          # Admin: kredittjustering (+/-)
â”‚   â”‚   â”œâ”€â”€ ai-admin-list-users/              # Admin: brukerliste/status/tier/limits
â”‚   â”‚   â”œâ”€â”€ ai-admin-update-user/             # Admin: allowlist + tier-endring
â”‚   â”‚   â”œâ”€â”€ ai-analyze-file/                  # Analyse av opplastede filer (multimodal)
â”‚   â”‚   â”œâ”€â”€ ai-generate-section/              # Server-side generering (SSE Streaming)
â”‚   â”‚   â”œâ”€â”€ ai-image/                         # Bildegenerering (Imagen 4.0)
â”‚   â”‚   â”œâ”€â”€ ai-mermaid-fix/                   # Mermaid-fiksing med AI
â”‚   â”‚   â”œâ”€â”€ ai-plan/                          # Planleggings-agent (Google Search)
â”‚   â”‚   â”œâ”€â”€ ai-script-convert/                # Konvertering til filmmanus
â”‚   â”‚   â”œâ”€â”€ ai-stripe-checkout/               # Oppretter Stripe Checkout for kredittkjÃ¸p
â”‚   â”‚   â”œâ”€â”€ ai-stripe-webhook/                # Verifiserer betaling og fyller kreditter
â”‚   â”‚   â”œâ”€â”€ ai-suggest-prompt/                # Prompt-forbedring
â”‚   â”‚   â”œâ”€â”€ ai-suggest-settings/              # Innstillings-anbefalinger
â”‚   â”‚   â”œâ”€â”€ ai-summarize/                     # Oppsummerings-agent
â”‚   â”‚   â”œâ”€â”€ ai-tts/                           # Tekst-til-tale (Gemini TTS)
â”‚   â”‚   â”œâ”€â”€ ai-user-profile/                  # Brukerprofil og preferanser
â”‚   â”‚   â”œâ”€â”€ url-analyze/                      # Analyse av nettsider (Scraping)
â”‚   â”‚   â””â”€â”€ deno.d.ts                         # Supplerende module declarations
â”‚   â””â”€â”€ migrations/                           # Database-migrasjoner
â”‚       â”œâ”€â”€ 20260120000000_quota_system.sql   # Kvote-system tabeller og RPC
â”‚       â”œâ”€â”€ 20260129000000_add_credits_columns.sql # Credits-kolonner og flyt
â”‚       â”œâ”€â”€ 20260216160000_fix_credit_idempotency_by_type.sql # Idempotens-fiks for kreditt-trekk
â”‚       â”œâ”€â”€ 20260216173000_create_admin_users_table.sql # Admin-brukere tabell
â”‚       â””â”€â”€ ...                               # Videre fixes/cleanup migrasjoner
â””â”€â”€ utils/                                    # Generelle hjelpefunksjoner
    â”œâ”€â”€ audio.ts                              # PCM/WAV-hjelpere (lavnivÃ¥)
    â”œâ”€â”€ dom.ts                                # DOM-manipulasjon
    â””â”€â”€ fileParser.ts                         # Parsing av opplastede filer (.txt gjenoppretting)
```
### NÃ¸kkelkomponenter forklart

* `services/ai/chapters.ts`: Kjernen i innholdsgenereringen. Bruker nÃ¥ "Smart Chunking" for Ã¥ bevare linjeskift i TTS-tekst, noe som er kritisk for korrekt videorendring og synkronisering.
* `services/export/video.ts`: Videomotor som bruker Canvas API og WebCodecs. Har innebygd logikk for Ã¥ splitte lange overskrifter fra brÃ¸dtekst visuelt.
* `services/export/website.ts`: Genererer en komplett HTML/CSS/JS-pakke som lar brukeren navigere i historien interaktivt.
* `services/sanitize/mermaidFixer.ts`: Intelligent "selvhelbredende" modul som oppdager syntaksfeil i Mermaid-diagrammer og fikser dem automatisk.
* `components/views/AdminUsersView.tsx`: Separat admin-view for brukerliste, allowlist-status, tier-endringer og kredittjustering.
* `shared/prompts/*`: Felles prompt source-of-truth for kjerneflytene (`ai-generate-section`, `ai-plan`, `ai-suggest-*`, `ai-mermaid-fix`) slik at frontend og Edge Functions bruker samme instruksjonsgrunnlag.
* `scripts/check-prompt-drift.mjs`: Drift-guard som stopper innfÃ¸ring av nye inline core-prompts i Edge Functions.
* `supabase/functions/_shared/utils.ts`: Delt logikk for Edge Functions inkludert auth, allowlist, admin checks, kvote-reservering og brukslogging.
* `supabase/functions/_shared/pricing.ts`: Server-side prismapping (`USD -> credits`) for konsistent kredittbelastning.
* `supabase/migrations/20260120000000_quota_system.sql`: Database-migrasjon med tabeller for `entitlements`, `usage_counters`, `usage_events` og atomiske RPC-funksjoner.

</details>

---

## ğŸš€ Tilgang & Installasjon

Kildekoden til Story Engine er for tiden i et privat repository (novel-planner) for Ã¥ beskytte immaterielle rettigheter (IP). Dette repoet fungerer som teknisk dokumentasjon.

For investorer, partnere eller utviklere som har fÃ¥tt tildelt tilgangsrettigheter, gjelder fÃ¸lgende oppsett:

### ğŸ› ï¸ Forutsetninger
*   **Node.js**: v20+
*   **Deno**: v2.6.8+ (for Edge Functions)
*   **Supabase CLI**: v2.76.3+

### ğŸš€ Installasjon

1.  **Klon kildekode-repoet**
   (Krever autorisasjon)
    ```bash
    git clone https://github.com/engan/novel-planner.git
    cd novel-planner
    ```

2.  **Installer avhengigheter**
    ```bash
    npm install
    ```

3.  **Sett opp miljÃ¸variabler**
    Lag en `.env.local` fil i rotmappen og legg inn Supabase-oppsett:
    ```env
    VITE_SUPABASE_URL=https://<project-ref>.supabase.co
    VITE_SUPABASE_ANON_KEY=<anon-key>
    ```
    For enkelte lokale testskript kan du i tillegg trenge:
    ```env
    VITE_GEMINI_API_KEY=din_nÃ¸kkel_her
    ```

4.  **Start utviklingsserveren**
    ```bash
    npm run dev
    ```
---

## ğŸ“ Endringslogg

Kortversjon av siste endringer. Full historikk finnes i `CHANGELOG.md` (og i GitHub Releases).

### Siste endringer (arbeidsgren / story-engine-dev)
- ğŸ¬ **Video**: Mermaid-diagrammer viser nÃ¥ "Diagram er utelatt i video"-melding. Listelementer beholder **bold**/*italic* formatering. Unummererte lister bruker bullet-punkt (â€¢). Inline math ($...$) konverteres til kursiv. Fleksibel tabelldeteksjon.
- ğŸ“„ **PDF/DOCX**: Inline math stÃ¸ttes som kursiv tekst. PDF-kodeblokker har emoji-til-tekst konvertering (jsPDF-begrensning). Forbedret word-wrap i kodeblokker.
- ğŸ™ï¸ **TTS**: Stemmenavn (Charon:, etc.) fjernes kun nÃ¥r de stÃ¥r som speaker-label pÃ¥ linjestarten â€“ bevarer legitim bruk i tekst.
- ğŸ”— **Lenker**: Konsistent lenkegjengivelse i video (cyan/understrek), PDF (blÃ¥/klikkbar), og DOCX (hyperlenker). Filtrerer ut "junk" grounding-lenker.
- ğŸ–¥ï¸ **UI**: Fikset tekstoverflyt i Generation Progress-kort.
- ğŸ› ï¸ **Refaktorering**: `externalApiService.ts` â†’ `api.ts`.

> Tips: Bruk GitHub Releases for "release notes", og hold `CHANGELOG.md` som den tekniske kilden.

---

## ğŸ—ºï¸ Veikart

Vi bygger fremtidens publiseringsverktÃ¸y. Her er hva som kommer:

*   ğŸ“° **Integrasjon mot Retriever/Mediearkivet**: For dypere faktasjekk mot norske kilder.
*   ğŸ—£ï¸ **Multi-LLM Konsensus-debatt**: La flere AI-modeller diskutere en sak fÃ¸r konklusjon trekkes.
*   ğŸ“» **Advanced Audio (Radio Play)**: Lydeffekter og bakgrunnsmusikk mikset med fortellerstemmen.
*   ğŸ—ï¸ **Pilotprosjekt med lokalavis**: Test av "Breaking News"-agent (f.eks journalist, etter avtale).
*   ğŸ“± **PWA-stÃ¸tte**: Full offline-stÃ¸tte for journalister i felt (etter avtale).

---

## ğŸµ Bonus: The Story Engine Anthem

Fordi en multimodal AI-plattform fortjener sitt eget lydspor. Tekst og melodi er generert for Ã¥ fange essensen av overgangen fra idÃ© til ferdig produkt.

> *"Story Engine / Turning one small flame to a wildfire..."*

[â–¶ï¸ **HÃ¸r sangen her (Suno)**](https://suno.com/s/bYmMmpVi77OgbCm2)

---

<details>
  <summary>ğŸ“Š</summary>
  <img src="https://komarev.com/ghpvc/?username=engan&label=V&color=0e75b6&style=flat" alt="BesÃ¸ksstatistikk" />
</details>

<div align="center">
  <p>Utviklet med â¤ï¸ i Norge</p>
  <p>Â© 2025-2026 Story Engine</p>
</div>
